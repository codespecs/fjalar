<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-15">
<title>Merging newer versions of Valgrind into Fjalar</title>
</head>
<body>
<h1>Merging newer versions of Valgrind into Fjalar</h1>


<p>
This document provides information on merging newer versions of Valgrind
into Fjalar.  Fjalar is built as a tool on top of Valgrind, and it it also
contains a sizable amount of code from Memcheck, another Valgrind tool,
When new versions of Valgrind and Memcheck are released, Fjalar should be
updated.</p>

<p>
Conceptually this is two separate merges: (1) The merge between
the underlying copy of Valgrind, and the newer version of Valgrind and (2)
The merge between the memcheck code contained in Fjalar and the newer version
of Memcheck.  Due to very tight dependence of the memcheck code
on Valgrind, the changes should be done simultaneously.
</p>

<p>
The merge of the underlying copy of Valgrind should be able to be done almost
completely automatically. Due to substantial modifications to the memcheck code,
some portion of the merge will have to be done manually.  The more frequent
the merges are, the easier they will be to do.  Monthly, at the very least, is
recommended.
<p>

<p>Contents:</p>
<!-- start toc.  do not edit; run html-update-toc instead -->
    <ul>
      <li><a href="#Getting_Started">1. Getting Started</a>
        <ul>
          <li><a href="#current_fjalar">1.1 Obtain a current copy of the Fjalar source</a></li>
          <li><a href="#current-valgrind">1.2 Obtain a current copy of the Valgrind Source</a></li>
          <li><a href="#old-valgrind">1.3 Obtain a copy of the Valgrind Source corresponding to the Fjalar version</a></li>
          <li><a href="#old-vex">1.4 Obtain a copy of the VEX Source corresponding to the Fjalar version</a></li>
        </ul></li>
      <li><a href="#Creating_the_diffs">2. Creating the diffs</a>
        <ul>
          <li><a href="#coregrind-diff">2.1 Coregrind Diff</a></li>
          <li><a href="#memcheck-diff">2.2 Memcheck Diff</a></li>
          <li><a href="#pag-coregrind-diff">2.3 PAG Coregrind Diff</a></li>
        </ul></li>
      <li><a href="#Merging_the_changes">3. Merging the changes</a>
        <ul>
          <li><a href="#coregrind-merge">3.1 Coregrind Merge</a></li>
          <li><a href="#coregrind-conflicts">3.2 Coregrind Conflicts</a></li>
          <li><a href="#memcheck-merge">3.3 Memcheck Merge</a></li>
          <li><a href="#memcheck-conflicts">3.4 Memcheck Conflicts</a></li>
          <li><a href="#Updating_Fjalar_Kvasir">3.5 Updating Fjalar/Kvasir</a></li>
        </ul></li>
      <li><a href="#Compiling">4. Compiling and Testing</a>
        <ul>
          <li><a href="#compiling_fjalar">4.1 Compiling Fjalar</a></li>
          <li><a href="#testing_fjalar">4.2 Testing Fjalar</a></li>
          <li><a href="#documenting_changes">4.3 Documenting Changes</a></li>
          <li><a href="#committing">4.4 Committing</a></li>
        </ul></li>
      <li><a href="#Valgrind_modifications">Appendix A: Valgrind modifications</a></li>
      <li><a href="#Memcheck_modifications">Appendix B: Memcheck modifications</a></li>
    </ul>
<!-- end toc -->

<hr>

<h2 id="Getting_Started">1. Getting Started</h2>


<p>
To begin you will need a checkout of Fjalar from CVS.
</p>

<p>Next you will need to obtain 2 copies of Valgrind: The most recent, and the
one the current version of Fjalar is based on. You can get up to date instructions
on pulling Valgrind from source from:</p>

<h3 id="current_fjalar">1.1 Obtain a current copy of the Fjalar source </h3>
The below steps can be omitted if you already have a copy of invariants/valgrind-3
checked out. If your current checkout contains any layout changes to the kvasir
directory, it may be more convenient to move your current checkout and follow the 
below directions.

(From a PAG machine)
<pre>
  cvs -d $pag/projects/invariants/.CVS co invariants
  cd invariants
  cvs -d $pag/projects/invariants/.CVS co valgrind-3</pre>


<h3 id="current-valgrind">1.2 Obtain a current copy of the Valgrind Source </h3>

<pre>  svn co svn://svn.valgrind.org/valgrind/trunk valgrind-new </pre>

<p>Additional information about working with the Valgrind repository can be found at: <a href="http://www.valgrind.org/downloads/repository.html">Valgrind: Code Repository</a></p>

<h3 id="old-valgrind">1.3 Obtain a copy of the Valgrind Source corresponding to the Fjalar version </h3>
<pre>  svn co -r [REVISION] svn://svn.valgrind.org/valgrind/trunk valgrind-old </pre>

<p>The revision of Valgrind currently used by Fjalar should be in [invariants]/kvasir/REVISION. </p>

<h3 id="old-vex">1.4 Obtain a copy of the VEX Source corresponding to the Fjalar version </h3>
From within the old Valgrind source directory run:
<pre>  svn update -r [REVISION] svn://svn.valgrind.org/vex/trunk VEX </pre>

<p>The revision of VEX currently used by Fjalar should also be in [invariants]/kvasir/REVISION. </p>

<p>The VEX instrumentation libraries Valgrind is built on is stored in a separate
SVN repository. A Valgrind checkout will always check out the most recent version of the VEX
source. This is fine for when we checked out the current Valgrind source, however,
we'll want the same version used in the Fjalar repository for the copy that will be
diffed.</p>
<hr>

<h2 id="Creating_the_diffs">2. Creating the diffs</h2>
<p>Two separate diffs will be created. One for non Memcheck code and one for Memcheck.</p>

<h3 id="coregrind-diff">2.1 Coregrind Diff</h3>
<pre> diff -ur --unidirectional-new-file -x 'Makefile.in' -x '.cvsignore' -x inst -x '.svn' -x CVS -x memcheck -x auxprogs -x cachegrind -x callgrind -x drd -x exp-omega -x exp-ptrcheck -x helgrind -x massif -x none -x lackey [<b>Valgrind-Old</b>] [<b>Valgrind</b>] > coregrind.patch</pre>


<h3 id="memcheck-diff">2.2 Memcheck Diff</h3>
<pre>  diff -ur --unidirectional-new-file -x 'Makefile.in' -x '.cvsignore' -x '.svn' -x CVS -x docs -x tests -x perf [<b>Memcheck-Old</b>] [<b>Memcheck</b>] > memcheck.patch</pre>


<h3 id="pag-coregrind-diff">2.3 PAG Coregrind Diff</h3>
<p> As an aid, it's recommended to generate a diff containing PAG changes to coregrind. This will not be used for any automated patching, so we will be excluding a lot more irrelevant files. Also the PAG repository contains many of the automake/autoconf generated files to simplify things for the end users, these also need to  be omitted for a cleaner diff. The below command should create a diff containing the relevant PAG changes to the Valgrind source code.

<pre>  diff -ur --unidirectional-new-file -x 'Makefile.in' -x '.cvsignore' -x inst -x '.svn' -x CVS -x memcheck -x auxprogs -x cachegrind -x callgrind -x drd -x exp-omega -x exp-ptrcheck -x helgrind -x massif -x none -x fjalar -x lackey -x aclocal.m4 -x compile -x config.sub -x config.guess -x config.h.in -x configure -x depcomp -x install-sh -x *.supp -x mkinstalldirs -x missing -x Makefile.install.am valgrind-old valgrind-3/valgrind/ > coregrind-PAG.diff
</pre>

<hr>

<h2 id="Merging_the_changes">3. Merging the changes</h2>

<h3 id="coregrind-merge">3.1 Coregrind Merge</h3>
<p>Now we can merge the changes from the created diffs. The coregrind patch should apply with very little conflicts.</p>

<p> In general it's somewhat difficult to undo a patch operation, so you should first attempt a dry run. </p>

<pre>
  cd <b>[Fjalar Valgrind]</b>
  patch -p1 < coregrind.patch --dry-run</pre>

<p> Keep on the lookout for irrelevant directories. If there are entire directories of content absent in our version it might be
indicative of a new Valgrind tool.  Examine the folder and see if it is relevant to our version. If the
patch fails outright it may be indicative of problems in the above diffing.</p>

<p>When you are ready to apply the patch run:</p>
<pre>  patch -p1 < coregrind.patch</pre>

<p> Be sure to run: </p>

<pre>  cvs add [file] </pre>

<p> On any files created in our repository and </p>

<pre>  cvs remove [file] </pre>

<p> for any files removed from our repository  </p>

<h3 id="coregrind-conflicts">3.2 Coregrind Conflicts</h3>

<p>You will need to handle any conflicts that occurred. For every conflicted file in the patch, a .rej file will be created
for the file. For every change in the file you will need to examine both the changed code as well as our original code and
determine if it needs to be hand merged or if the change is not relevant. It is useful to refer to the .diff file you
created containing our changes during this process.</p>

<h3 id="memcheck-merge">3.3 Memcheck Merge</h3>

<pre>
  cd <b>[Fjalar]</b>
  patch -p2 < memcheck.patch --dry-run</pre>

<p> If the patch output looks sane, continue with the actual merge </p>

<pre>  patch -p2 < memcheck.patch </pre>

<p> Be sure to run: </p>

<pre>  cvs add [file] </pre>

<p> On any files created in our repository and </p>

<pre>  cvs remove [file] </pre>

<p> for any files removed from our repository  </p>

<h3 id="memcheck-conflicts">3.4 Memcheck Conflicts</h3>

<p>As with the coregrind merge you will need to handle any conflicts that have arisen. The process is the same, however
our changes to Memcheck are much more substantial than our changes to Coregrind. Some notes on particular problem areas
are below.</p>

<p>The largest modification to the memcheck is located in mc_translate.c and special care should be made
to ensure it is present and up to date. in MC_(instrument), the code which handles the instrumentation
of calls for Dyncomp is present. It is primarily contained in a case-switch statement below the
case-switch statement for Memcheck. MC_(instrument) switches off on every VEX instruction type and performs
some operation for it. There should be an analogous for Dyncomp operation in the second
case-switch for every memcheck operation in the first one.</p>

<h3 id="Updating_Fjalar_Kvasir">3.5 Updating Fjalar/Kvasir</h3>

<p>Additionally Fjalar/Kvasir need to be updated to properly handle any changes in Valgrind API/functionality.
. For the most part Valgrind maintains a relatively  stable interface to it's tools. Any tool-visible changes
should be noted in the change logs.</p>

<p>A somewhat more problematic area are changes in the VEX IR. Dyncomp makes heavy use of the VEX IR, so any
changes in it need to be reflected. Most of the changes to the public VEX IR can be discovered by running the following command:</p>

<pre>  svn log -r [LAST-REVISION]:HEAD VEX/pub/libvex_ir.h</pre>

<p>
The files with all the VEX IR code for Dyncomp is located in dyncomp_translate.[ch]. dyncomp_translate.c
is structured primarily into functions of the form <i>expr2tags_[EXPRESSION_TYPE]()</i>. These functions
will  contain a switch for all VEX IR instructions corresponding to the expression type and some
call to a dyncomp tag function. Most often VEX IR changes will be syntactical in nature and will only
involve changing the names of the instructions.

<hr>


<h2 id="Compiling">4. Compiling and Testing</h2>
<p>We must now ensure that the merged code compiles correctly and passes the regression test suite.</p>

<h3 id="compiling_fjalar">4.1 Compiling Fjalar</h3>

<pre>
  cd valgrind-3
  ./auto-everything.sh </pre>

<p> The auto-everything shell script should handle autogen'ing the config and Makefiles as well
compiling Fjalar. Be sure to fix any compilation errors that pop up at this point.</p>

<h3 id="testing_fjalar">4.2 Testing Fjalar</h3>
<p>The regression suite is located in the tests/kvasir-tests directory. It can be run using the following
commands</p>

<pre>
  cd [invariants]/tests/kvasir-tests 
  make nightly-summary-w-daikon</pre>

<p>The test suite should pass without modification.</p>

<h3 id="documenting_changes">4.3 Documenting Changes</h3>

<p>Any user-visible changes should be documented in [invariants]/docs/CHANGES. Additionally both this file
(valgrind_merge.html) and [invariants]/kvasir/REVISION should be updated with the Valgrind
and VEX revisions that were used for this merge.</p>

<p>The revision for Valgrind can be obtained using the follow commmands:</p>

<pre>
  cd [valgrind-new]
  svn info</pre>

<p>The revision for VEX can be obtained by:</p>

<pre>
  cd [valgrind-new]/VEX
  svn info</pre>


<h3 id="committing"> 4.4 Committing </h3>

<p>One the above is finished, if the test suite passes with no errors and all changes are documented, changes
should be committed to the CVS repository.</p>

<pre>
  cd [invariants] 
  cvs commit -m "Valgrind merge from revision[Old-revision] to [new-revision]. VEX IR merge from [old-revision] to [new-revision]. [Any other relevant notes]</pre>

<hr>
<h2 id="Valgrind_modifications">Appendix A: Valgrind modifications</h2>

<p>In an effort to aid in determining the appropriate measures to take when merging conflicted files,
this section will provide a list of files modified by us and a brief explanation of the changes.

<!-- Should I include functions too? -->

<p>The most important set of changes is the addition of extra shadow state in Coregrind and VEX.
The shadow area is an area of memory that Valgrind provides for tools to use. Unfortunately,
it is of a fixed size, and memcheck uses all of it. We've had to increase the size of the
the shadow area.

<dl>
<dt>coregrind/pub_core_threadstate.h</dt>
<dd>The declaration of the extra shadow space</dd>
<dt>coregrind/m_scheduler/scheduler.c</dt>
<dd>An assertion that triggers based on shadow size</dd>
<dt>VEX/priv/host-generic/reg_alloc2.c</dt>
<dd>memory calculation using the shadow size</dd>
</dl>

<dl><dt>Addition of primary/secondary integer return registers to the guest state:</dt>
<dt>VEX/priv/guest-x86/ghelpers.c</dt>
<dt>VEX/pub/libvex.h</dt>
<dt>coregrind/m_machine.c: Tool-visible functions to access these values:</dt>
<dt>include/pub_tool_machine.h</dt></dl>

<dl><dt>Addition of an extra libc functions.</dt>
<dt>valgrind-3.4.0/coregrind/m_libcfile.c</dt>
<dt>include/pub_tool_libcfile.h</dt></dl>
<hr>

<h2 id="Memcheck_modifications">Appendix B: Memcheck modifications</h2>

<p>The modifications made to memcheck are more organizational in nature. A few functions from
mc_main.c and mc_translate.c have been made non-static. An extra header has also been created
and filled with their signatures for use by Fjalar.</p>

<p>Other modifications include:</p>
<dl>
<dt>mc_malloc_wrappers.c</dt>
<dd>Calls to Dyncomp functions for memory operations.</dd>
<dt>mc_main.c</dt>
<dd>Run-time arguments and versioning information for Kvasir to replace the default memcheck ones</dd>
<dt>mc_translate.c</dt>
<dd>A duplicate of memcheck's instrumentation block for Dyncomp.</dd></dl>

<hr>
<address></address>
<!-- hhmts start -->Last modified: June 27, 2009<!-- hhmts end -->
</body> </html>

<!--  LocalWords:  Memcheck memcheck Kvasir diffs Coregrind Diff valgrind PAG
 -->
<!--  LocalWords:  cvs pag co cd svn kvasir diffed diff ur cvsignore inst drd
 -->
<!--  LocalWords:  auxprogs cachegrind callgrind exp ptrcheck helgrind massif
 -->
<!--  LocalWords:  coregrind perf automake autoconf fjalar aclocal config supp
 -->
<!--  LocalWords:  depcomp mkinstalldirs diffing rej mc Dyncomp dyncomp ch expr
 -->
<!--  LocalWords:  autogen'ing daikon html libc malloc versioning memcheck's
 -->
<!--  LocalWords:  EDT
 -->

<!--
Local Variables:
time-stamp-start: "^.![-]- hhmts start [-]-.Last modified: "
time-stamp-end: "<.[-]- hhmts end [-]-.$"
time-stamp-format: "%:b %:d, %:y"
time-stamp-line-limit: -50
End:
-->
